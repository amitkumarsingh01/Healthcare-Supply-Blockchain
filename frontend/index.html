<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Supply Chain - Blockchain Medicine Tracking</title>
    <link rel="stylesheet" href="style.css?v=2">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1><i class="fas fa-pills"></i> Healthcare Supply Chain</h1>
                <p>Blockchain-powered medicine tracking system</p>
            </div>
            <div class="wallet-section">
                <button id="connectWallet" class="btn btn-primary">
                    <i class="fas fa-wallet"></i> Connect MetaMask
                </button>
                <div id="walletInfo" class="wallet-info" style="display: none;">
                    <span id="walletAddress"></span>
                    <span id="walletBalance"></span>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <button class="nav-btn active" data-section="dashboard">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </button>
            <button class="nav-btn" data-section="medicines">
                <i class="fas fa-pills"></i> Medicines
            </button>
            <button class="nav-btn" data-section="manufacture">
                <i class="fas fa-industry"></i> Manufacture
            </button>
            <button class="nav-btn" data-section="track">
                <i class="fas fa-search"></i> Track Medicine
            </button>
            <button class="nav-btn" data-section="transfer">
                <i class="fas fa-exchange-alt"></i> Transfer
            </button>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-pills"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="totalMedicines">0</h3>
                            <p>Total Medicines</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-industry"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="manufacturedMedicines">0</h3>
                            <p>Manufactured</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-truck"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="inTransitMedicines">0</h3>
                            <p>In Transit</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-store"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="pharmacyMedicines">0</h3>
                            <p>At Pharmacy</p>
                        </div>
                    </div>
                </div>
                
                <div class="recent-activity">
                    <h3>Recent Activity</h3>
                    <div id="recentActivity" class="activity-list">
                        <!-- Activity items will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Medicines Section -->
            <section id="medicines" class="content-section">
                <h2><i class="fas fa-pills"></i> All Medicines</h2>
                <div class="search-bar">
                    <input type="text" id="medicineSearch" placeholder="Search medicines by name or batch number...">
                    <button id="searchBtn" class="btn btn-secondary">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                <div id="medicinesList" class="medicines-grid">
                    <!-- Medicine cards will be loaded here -->
                </div>
            </section>

            <!-- Manufacture Section -->
            <section id="manufacture" class="content-section">
                <h2><i class="fas fa-industry"></i> Manufacture Medicine</h2>
                <form id="manufactureForm" class="form">
                    <div class="form-group">
                        <label for="medicineName">Medicine Name</label>
                        <input type="text" id="medicineName" required>
                    </div>
                    <div class="form-group">
                        <label for="batchNumber">Batch Number</label>
                        <input type="text" id="batchNumber" required>
                    </div>
                    <div class="form-group">
                        <label for="expiryDate">Expiry Date</label>
                        <input type="date" id="expiryDate" required>
                    </div>
                    <div class="form-group">
                        <label for="temperatureThreshold">Temperature Threshold (°C)</label>
                        <input type="number" id="temperatureThreshold" min="0" max="50" value="25">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="temperatureSensitive">
                            Temperature Sensitive
                        </label>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Manufacture Medicine
                    </button>
                </form>
            </section>

            <!-- Track Medicine Section -->
            <section id="track" class="content-section">
                <h2><i class="fas fa-search"></i> Track Medicine</h2>
                <div class="search-section">
                    <div class="form-group">
                        <label for="trackMedicineId">Medicine ID</label>
                        <input type="number" id="trackMedicineId" placeholder="Enter medicine ID">
                        <button id="trackBtn" class="btn btn-primary">
                            <i class="fas fa-search"></i> Track
                        </button>
                    </div>
                </div>
                <div id="trackingResults" class="tracking-results" style="display: none;">
                    <!-- Tracking results will be displayed here -->
                </div>
            </section>

            <!-- Transfer Section -->
            <section id="transfer" class="content-section">
                <h2><i class="fas fa-exchange-alt"></i> Transfer Medicine</h2>
                <form id="transferForm" class="form">
                    <div class="form-group">
                        <label for="transferMedicineId">Medicine ID</label>
                        <input type="number" id="transferMedicineId" required>
                    </div>
                    <div class="form-group">
                        <label for="transferTo">Transfer To Address</label>
                        <input type="text" id="transferTo" placeholder="0x..." required>
                    </div>
                    <div class="form-group">
                        <label for="transferStatus">New Status</label>
                        <select id="transferStatus" required>
                            <option value="">Select Status</option>
                            <option value="SHIPPED_TO_DISTRIBUTOR">Shipped to Distributor</option>
                            <option value="RECEIVED_BY_DISTRIBUTOR">Received by Distributor</option>
                            <option value="SHIPPED_TO_PHARMACY">Shipped to Pharmacy</option>
                            <option value="RECEIVED_BY_PHARMACY">Received by Pharmacy</option>
                            <option value="SOLD_TO_PATIENT">Sold to Patient</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="transferLocation">Location</label>
                        <input type="text" id="transferLocation" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-exchange-alt"></i> Transfer Medicine
                    </button>
                </form>
            </section>
        </main>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-spinner">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Processing transaction...</p>
            </div>
        </div>

        <!-- Notification -->
        <div id="notification" class="notification" style="display: none;">
            <span id="notificationMessage"></span>
            <button id="closeNotification" class="close-btn">&times;</button>
        </div>
    </div>

    <!-- Load ethers.js with local file as primary source -->
    <script>
        // Try to load ethers.js from local file first, then CDN fallbacks
        const loadEthers = () => {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = './ethers.js?v=1'; // Local file first with cache busting
                script.onload = () => {
                    console.log('✅ Ethers.js loaded from local file');
                    resolve();
                };
                script.onerror = () => {
                    console.warn('⚠️ Local file failed, trying CDN...');
                    // Try primary CDN
                    const cdnScript = document.createElement('script');
                    cdnScript.src = 'https://cdn.ethers.io/lib/ethers-5.7.2.umd.min.js';
                    cdnScript.onload = () => {
                        console.log('✅ Ethers.js loaded from primary CDN');
                        resolve();
                    };
                    cdnScript.onerror = () => {
                        console.warn('⚠️ Primary CDN failed, trying fallback...');
                        // Try fallback CDN
                        const fallbackScript = document.createElement('script');
                        fallbackScript.src = 'https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js';
                        fallbackScript.onload = () => {
                            console.log('✅ Ethers.js loaded from fallback CDN');
                            resolve();
                        };
                        fallbackScript.onerror = () => {
                            console.error('❌ All sources failed to load ethers.js');
                            reject(new Error('Failed to load ethers.js from any source'));
                        };
                        document.head.appendChild(fallbackScript);
                    };
                    document.head.appendChild(cdnScript);
                };
                document.head.appendChild(script);
            });
        };

        // Load ethers.js before other scripts
        loadEthers().then(() => {
            // Load other scripts after ethers.js is ready with cache busting
            const metamaskScript = document.createElement('script');
            metamaskScript.src = 'metamask.js?v=' + new Date().getTime();
            document.head.appendChild(metamaskScript);
            
            const appScript = document.createElement('script');
            appScript.src = 'app.js?v=' + new Date().getTime();
            document.head.appendChild(appScript);
        }).catch(error => {
            console.error('Failed to load ethers.js:', error);
            document.body.innerHTML = '<div style="text-align: center; padding: 50px; color: red;"><h2>❌ Failed to load required libraries</h2><p>Please check your internet connection and refresh the page.</p></div>';
        });
    </script>
</body>
</html>
